# See https://github.com/pypa/python-manylinux-demo
# vim: set ts=8 sts=2 sw=2:
notifications:
  email: false

language: python
python: 3.6
os: linux

stages:
  - name: test
    #DEBUG
    if: (branch IN (master, multi-platform-builds)) OR (tag =~ /^release-/)
  - name: deploy
    #DEBUG
    if: (type = push) AND (branch IN (master, multi-platform-builds))
    #if: (type = push) AND (tag =~ /^release-/)

jobs:
  include:
    - name: "Run tests"
      before_script:
        - scripts/build-sdist.sh
      script:
        - scripts/run-tests.sh
#   - stage: deploy
#     name: "Build manylinux2014"
#     services:
#       - docker
#     env: DOCKER_IMAGE=quay.io/pypa/manylinux2014_x86_64
#          PLAT=manylinux2014_x86_64
#     before_install:
#       - docker pull $DOCKER_IMAGE
#   - name: "Build manylinux2010"
#     services:
#       - docker
#     env: DOCKER_IMAGE=quay.io/pypa/manylinux2010_x86_64
#          PLAT=manylinux2010_x86_64
#     before_install:
#       - docker pull $DOCKER_IMAGE
#   - name: "Build manylinux2010 (32-bit)"
#     services:
#       - docker
#     env: DOCKER_IMAGE=quay.io/pypa/manylinux2010_i686
#          PRE_CMD=linux32
#          PLAT=manylinux2010_i686
#     before_install:
#       - docker pull $DOCKER_IMAGE
    - stage: deploy
      #DEBUG ^
      name: "Build for macOS"
      os: osx
      language: generic
      script:
        - scripts/build-mac.sh
        - ls dist/
#   - name: "Build for Windows (Python 3.6)"
#     os: windows
#     language: generic
#     before_install:
#       - choco install python3 --version=3.6
#       - python3 -m pip install --upgrade pip setuptools wheel
#     env: PATH=/c/Python36:/c/Python36/Scripts:$PATH
#     script:
#       - scripts/build-win.sh
#       - ls dist/
#   - name: "Build for Windows (Python 3.7)"
#     os: windows
#     language: generic
#     before_install:
#       - choco install python3 --version=3.7
#       - python3 -m pip install --upgrade pip setuptools wheel
#     env: PATH=/c/Python36:/c/Python36/Scripts:$PATH
#     script:
#       - scripts/build-win.sh
#       - ls dist/
#   - name: "Build for Windows (Python 3.8)"
#     os: windows
#     language: generic
#     before_install:
#       - choco install python3 --version=3.8
#       - python3 -m pip install --upgrade pip setuptools wheel
#     env: PATH=/c/Python36:/c/Python36/Scripts:$PATH
#     script:
#       - scripts/build-win.sh
#       - ls dist/

install:
  - scripts/fetch-md4c.sh md4c-lib

script:
  - docker run --rm -e PLAT=$PLAT -v `pwd`:/io $DOCKER_IMAGE $PRE_CMD /io/scripts/build-linux.sh
  - ls dist/

deploy:
  provider: pypi
  skip_cleanup: true
  # Workaround to keep dpl from running "python setup.py sdist" (setting to
  # empty string errors the build)
  distributions: "--version"
  username: "__token__"
  #password:
  #  secure: "HBIZNf2wVDheWxbHpJxpMafVGfkmbUTJ1L2LqkZVxXwu0FTVCk5qaTSLcAqjpQN8HpZXQe1TE6osjfiy8qjuuQuNRAyzFpjLu9Kw7Vl571cYLe7cpYFdZeyDn0rYHP7gCYB4lNlw7b3ahlLl8UZ/2u26y4MZKx+0pqPgrxBZ3mjefcKwtf41CGayGh2YxB3dbJKDnYZGeXIml4Iq9aOK2GjH7sNaLB/QLDJcYtz1CSN+L7dU+qXRUcb209Tn/s1IQXhKz2PSqAxgUUdtfROTZT+41GORsJEGuM7VEJ/aZYGChyaTGh0iIwYslCpoW2ZuZjTFDfcpO0xd88R2YT4B6B3eoZGWRAO3hqGGtKEQBic8HpFbIdMeoPcb/2cxfqOuIFMnRvGE6tLKlgHHuSGzHN3u6hJWfwHw52jj4osBrzwRclKzERwkB/qXUbguTvoHsOyTt0YwsRFWbkmiuVdNXJ7JBbtszCtVqKcQNZZv/CnBQC6oX7VrfLY76eeeN4k6/8UcacYtvreM8mdkXiMOiKL8TDL+pqTF0cx0G6SKdrfOguueXb5pIUTUCSAgEwA1+65DGfdbjb/jpQ/PhJhiSx1FHcMFZc6LLLz3qtBQDtsL/IZp7W7gOXWcPuvX+3oLZ8OLjGg4weXTgNOdex3JDQfOQIDTzIf5n5m8UZfV9Jc="
  on:
    tags: true
    condition: $TRAVIS_TAG = release-*
  #DEBUG
  server: https://test.pypi.org/legacy/
  password:
    secure: "aq8Q5HuW5wv8DyTXIGeZHonJWlLBOnnT2CS7SFz0Dbb9xdTIihoJmASyqfwbdKicpzyt9snTtN0HL64O98+h3r8Bdsiu/QGOli2/oKmACPd+7+Kl0JnujaordDMhUxGZ3zz6W6RdL4/zuz2Gupb5P2aweVyf3rA65e2PBA+hsVj4JeX/XhrskMINh1qw5doYpUZ1ZOzi0bB1KGJoL3ArJsR8uj5bDoVwXIHolM68tGjtYAEGNVNdZLfRMudwn2H9bWYBBbdYBuRKiIrfFFrT9UV+ruxaM7+mA5K8EtG28cVyDxN1h6Xu1aoeWHMokZfZ4Ji7NtAAM/DWMfVqdTZc6jAis6FyWIqyABtkSfY+W+gi9d1UWfDnY2uYDtOw1coWUNlutcZycSZ9jz5TJWXkHs9Eck1CTIoCjXegvzQqmPjFJWFHnZSFiUk0RpkxBIjID18s56jjNePPeuJWxMfR5grf+/9EfFH2ASG/BsssB0yNvWtOPBrCr5Ofb0UWp5DBFdYMUKwKrypeN2KG5dgUIVKkX2Uv4QdmB+OX405a9tjMBp9ngFS5uXyxyLVqPCwtRgWTRgFhkUk8otuKhnTieGMYWwa6/QtwXDt+MYnrMjZ64uAqBO1eyPIfLit96vTtlxFo+ZqsNDpoAajeh3gV/G3PFeoMsJqUsIa8PiAlVNo="
  skip_existing: true
